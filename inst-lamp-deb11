#!/bin/bash

sudo apt update
#install Apache + php + php-modules
sudo apt install -y apache2 apache2-utils php7.4 php7.4-mysql libapache2-mod-php7.4 php7.4-cli php7.4-cgi php7.4-gd
#make directory fot the future site
sudo mkdir /var/www/task
echo "Apache2 installed"
#change Apache config (copy config-file from GIT directory of current user to Apache directory
sudo cp /home/$USER/inst-lamp-deb11/apache.conf /etc/apache2/sites-available/apache.conf
sudo a2enmod rewrite
sudo a2ensite apache.conf
sudo service apache2 restart
echo "Apache2 listening port changed to 8081"
#install NGINX
sudo apt install -y nginx
echo "NGINX installed"
#change NGINX config
sudo cp /home/$USER/inst-lamp-deb11/nginx-conf /etc/nginx/sites-available/nginx
sudo service nginx restart
echo "NGINX redirection to Apache enabled"

#install database
sudo apt install -y mariadb-server mariadb-client

#security setting 
echo -e "\n\033[33m Please enter new root password for MySQL!\n"
read -s rpwd
sudo mysql -e "SET PASSWORD FOR root@localhost = PASSWORD('$rpwd');FLUSH PRIVILEGES;" 
printf "$rpwd\n n\n n\n n\n y\n y\n y\n" | sudo mysql_secure_installation

#create database and user
echo -e "\033[33m Please enter name of new database"
read db
echo -e "\033[33m Please enter new user's name"
read uname
echo -e "\033[33m Please enter password for $uname"
read -s upwd

sudo mysql -uroot -p$rpwd -e "CREATE DATABASE ${db} /*\!40100 DEFAULT CHARACTER SET utf8 */;"
sudo mysql -uroot -p$rpwd -e "CREATE USER ${uname} IDENTIFIED BY '${upwd}';"
sudo mysql -uroot -p$rpwd -e "GRANT ALL PRIVILEGES ON ${db}.* TO '${uname}';"
sudo mysql -uroot -p$rpwd -e "FLUSH PRIVILEGES;"

echo -e "\n\n\033[32m Database has succesful created"

cd /tmp
wget https://wordpress.org/latest.tar.gz

tar -xvzf latest.tar.gz
sudo mv wordpress/* /var/www/task/

sudo chmod -R 755 /var/www/task
sudo chown -R www-data:www-data /var/www/task/
#
cd /var/www/task/
sudo mv wp-config-sample.php wp-config.php
#
sudo service nginx restart
sudo service apache2 restart
